<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨åŸºé‡‘ç›‘æ§ç³»ç»Ÿ - Master-Detail</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* Masteré¡µé¢ç‰¹æœ‰çš„æ ·å¼ï¼ˆä¸ä¸common.cssé‡å¤çš„ï¼‰ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .global-status-bar {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 8px 20px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            gap: 15px;
            flex-wrap: wrap;
            z-index: 100; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
        }
        
        .status-group { display: flex; align-items: center; gap: 15px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        
        .status-indicator {
            width: 8px; height: 8px; border-radius: 50%;
            background-color: #27ae60; animation: pulse 2s infinite;
        }
        .status-indicator.error { background-color: #e74c3c; }
        .status-indicator.paused { background-color: #f39c12; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* å…¨å±€æ§åˆ¶æŒ‰é’® */
        .global-controls { display: flex; gap: 8px; }
        /* ç»Ÿä¸€æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            user-select: none;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 16px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219150;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* å…¨å±€æ§åˆ¶æŒ‰é’® */
        .global-btn {
            padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;
            font-size: 12px; font-weight: 600; transition: all 0.2s; color: white;
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
        }
        .global-btn:hover { background: rgba(255,255,255,0.3); }
        .global-btn.active { background: #e74c3c; border-color: #e74c3c; }
        .global-btn.refresh { background: #3498db; border-color: #3498db; }

        /* æ—¥å¿—æŒ‰é’®æ ·å¼ */
        .log-btn {
            background: #f39c12;
            border: 1px solid #f39c12;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .log-btn:hover {
            background: #e67e22;
            border-color: #e67e22;
        }

        /* ä¸»å®¹å™¨ï¼šMaster-Detail å¸ƒå±€ */
        .master-detail-container { display: flex; flex: 1; overflow: hidden; }
        
        /* å·¦ä¾§ï¼šMaster (å¯¼èˆª) */
        .master-panel {
            width: 250px; background: white; border-right: 1px solid #e0e0e0;
            display: flex; flex-direction: column; flex-shrink: 0;
            transition: width 0.3s ease;
        }
        .master-header { padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fafafa; }
        .master-header h1 { font-size: 18px; color: #2c3e50; margin-bottom: 5px; }
        .master-header p { font-size: 12px; color: #7f8c8d; }
        
        .nav-list { list-style: none; padding: 10px 0; flex: 1; overflow-y: auto; }
        .nav-item {
            padding: 15px 20px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 12px; border-left: 4px solid transparent; color: #555;
        }
        .nav-item:hover { background-color: #f8f9fa; color: #3498db; }
        .nav-item.active { background-color: #e3f2fd; color: #1565c0; border-left-color: #1565c0; font-weight: 600; }
        .nav-icon { font-size: 18px; width: 20px; text-align: center; }

        /* å³ä¾§ï¼šDetail (å†…å®¹åŒºåŸŸ) */
        .detail-panel { flex: 1; background: #f8f9fa; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .detail-header { background: white; padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .detail-title { font-size: 16px; font-weight: 600; color: #2c3e50; }
        .detail-content { flex: 1; overflow: hidden; background: white; position: relative; }

        /* Iframe å®¹å™¨ */
        .iframe-wrapper { width: 100%; height: 100%; display: none; opacity: 0; transition: opacity 0.3s ease; }
        .iframe-wrapper.active { display: block; opacity: 1; }
        .iframe-wrapper iframe { width: 100%; height: 100%; border: none; background: white; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .master-detail-container { flex-direction: column; }
            .master-panel { width: 100%; height: auto; max-height: 200px; border-right: none; border-bottom: 1px solid #e0e0e0; }
            .nav-list { display: flex; overflow-x: auto; padding: 5px; }
            .nav-item { flex-shrink: 0; padding: 10px 15px; border-left: none; border-bottom: 3px solid transparent; }
            .nav-item.active { border-left-color: transparent; border-bottom-color: #1565c0; }
            .master-header { display: none; }
            .global-status-bar { padding: 5px 10px; font-size: 11px; }
            .global-btn { padding: 4px 8px; font-size: 11px; }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center;
            z-index: 10; display: none;
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- æ–°å¢ï¼šæ—¥å¿—æ¨¡æ€æ¡†æ ·å¼ --- */
        #logModal {
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 2000; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            justify-content: center; 
            align-items: center;
        }
        #logModal .modal-content {
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            width: 90%; 
            max-width: 900px; 
            max-height: 90vh; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #logModal .modal-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        #logModal .modal-header h3 { margin: 0; font-size: 18px; color: #2c3e50; }
        
        /* --- ä¿®å¤ï¼šæ¨¡æ€æ¡†å†…çš„æŒ‰é’®æ ·å¼ --- */
        #logModal .modal-header button {
            background: #3498db; /* è“è‰²èƒŒæ™¯ */
            color: white; /* ç™½è‰²æ–‡å­— */
            border: 1px solid #2980b9; /* æ·±è“è‰²è¾¹æ¡† */
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        #logModal .modal-header button:hover {
            background: #2980b9; /* æ‚¬åœæ—¶å˜æ·± */
        }
        /* å±é™©æ“ä½œæŒ‰é’®ï¼ˆæ¸…ç©ºæ—¥å¿—ï¼‰ */
        #logModal .modal-header button.danger {
            background: #e74c3c; /* çº¢è‰²èƒŒæ™¯ */
            border-color: #c0392b; /* æ·±çº¢è‰²è¾¹æ¡† */
        }
        #logModal .modal-header button.danger:hover {
            background: #c0392b; /* æ‚¬åœæ—¶å˜æ·± */
        }

        #logModal .modal-body {
            flex: 1; 
            overflow-y: auto; 
            background: #f8f9fa; 
            padding: 10px; 
            border: 1px solid #e0e0e0; 
            font-family: monospace; 
            font-size: 12px; 
            line-height: 1.5;
            border-radius: 4px;
        }
        
        /* --- ä¿®æ”¹ï¼šæ—¥å¿—æ¡ç›®æ ·å¼ --- */
        #logModal .log-entry {
            margin-bottom: 2px; 
            padding: 2px 4px; 
            border-radius: 3px;
            white-space: nowrap; /* å¼ºåˆ¶å•è¡Œ */
            overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ† */
            text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†æ˜¾ç¤ºçœç•¥å· */
            user-select: text; /* å…è®¸é€‰ä¸­å¤åˆ¶ */
            cursor: pointer; /* é¼ æ ‡å˜ä¸ºæ‰‹å‹ï¼Œæç¤ºå¯ç‚¹å‡» */
            transition: background-color 0.2s;
        }
        #logModal .log-entry:hover {
            background-color: #e8e8e8; /* æ‚¬åœæ—¶é«˜äº® */
        }
        /* ç‚¹å‡»å¤åˆ¶åçš„åé¦ˆæ ·å¼ */
        #logModal .log-entry.copied {
            background-color: #d4edda; /* æµ…ç»¿è‰²èƒŒæ™¯ */
            color: #155724; /* æ·±ç»¿è‰²æ–‡å­— */
        }
        
        #logModal .log-timestamp { color: #666; min-width: 85px; display: inline-block; }
        #logModal .log-page { color: #3498db; font-weight: bold; min-width: 60px; display: inline-block; }
        #logModal .log-function { color: #9b59b6; min-width: 50px; display: inline-block; }
        #logModal .log-level { font-weight: bold; min-width: 45px; display: inline-block; }
        #logModal .log-message { color: #333; }
        
        /* æ—¥å¿—çº§åˆ«é¢œè‰² */
        .log-level-ERROR { color: #e74c3c !important; }
        .log-level-WARNING { color: #f39c12 !important; }
        .log-level-INFO { color: #27ae60 !important; }
        .log-level-DEBUG { color: #7f8c8d !important; }

        /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .confirm-modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .confirm-message {
            margin: 15px 0;
            font-size: 16px;
            color: #333;
        }

        .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s;
        }

        .confirm-btn.confirm {
            background: #e74c3c;
            color: white;
        }

        .confirm-btn.confirm:hover {
            background: #c0392b;
        }

        .confirm-btn.cancel {
            background: #95a5a6;
            color: white;
        }

        .confirm-btn.cancel:hover {
            background: #7f8c8d;
        }
    </style>
</head>
<body>
    <!-- å…¨å±€çŠ¶æ€æ  -->
    <div class="global-status-bar">
        <div class="status-group">
            <div class="status-item">
                <div class="status-indicator" id="systemStatus"></div>
                <span id="statusText">ç³»ç»Ÿè¿è¡Œä¸­</span>
            </div>
            <div class="status-item">
                <span id="currentTime"></span>
            </div>
        </div>
        
        <div class="global-controls">
            <button class="global-btn refresh" onclick="globalManualRefresh()">æ‰‹åŠ¨åˆ·æ–°</button>
            <button class="global-btn" id="pauseBtn" onclick="toggleGlobalRefresh()">æš‚åœåˆ·æ–°</button>
            <!-- æ–°å¢ï¼šæ—¥å¿—æŒ‰é’® -->
            <button class="log-btn" onclick="openLogModal()">ç³»ç»Ÿæ—¥å¿—</button>
        </div>
    </div>

    <!-- Master-Detail ä¸»å®¹å™¨ -->
    <div class="master-detail-container">
        <!-- Master: å¯¼èˆªé¢æ¿ -->
        <div class="master-panel">
            <div class="master-header">
                <h1>ç›‘æ§ä¸­å¿ƒ</h1>
                <p>è‚¡ç¥¨åŸºé‡‘å®æ—¶ç›‘æ§</p>
            </div>
            <ul class="nav-list">
                <li class="nav-item active" onclick="switchView('stock')">
                    <span class="nav-icon">ğŸ“ˆ</span>
                    <span>è‚¡ç¥¨ç›‘æ§</span>
                </li>
                <li class="nav-item" onclick="switchView('fund')">
                    <span class="nav-icon">ğŸ’°</span>
                    <span>åŸºé‡‘æŸ¥è¯¢</span>
                </li>
                <!-- æ–°å¢ï¼šåŸºé‡‘äº¤æ˜“ç®¡ç†å…¥å£ -->
                <li class="nav-item" onclick="switchView('fund_trans')">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span>åŸºé‡‘äº¤æ˜“ç®¡ç†</span>
                </li>
                <!-- æ–°å¢ï¼šä»·æ ¼é€šçŸ¥ç®¡ç†å…¥å£ -->
                <li class="nav-item" onclick="switchView('notification')">
                    <span class="nav-icon">ğŸ””</span>
                    <span>ä»·æ ¼é€šçŸ¥ç®¡ç†</span>
                </li>
                <!-- æ–°å¢ï¼šç³»ç»Ÿæ›´æ–°å…¥å£ -->
                <li class="nav-item" onclick="switchView('update')">
                    <span class="nav-icon">ğŸ”„</span>
                    <span>ç³»ç»Ÿæ›´æ–°</span>
                </li>
            </ul>
        </div>

        <!-- Detail: å†…å®¹åŒºåŸŸ -->
        <div class="detail-panel">
            <div class="detail-header">
                <div class="detail-title" id="viewTitle">è‚¡ç¥¨ç›‘æ§</div>
            </div>
            
            <div class="detail-content">
                <!-- åŠ è½½é®ç½© -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                </div>

                <!-- è‚¡ç¥¨é¡µé¢ Iframe -->
                <div id="stockWrapper" class="iframe-wrapper active">
                    <iframe src="/stock_page" title="è‚¡ç¥¨ç›‘æ§" onload="hideLoading()"></iframe>
                </div>
                
                <!-- åŸºé‡‘é¡µé¢ Iframe -->
                <div id="fundWrapper" class="iframe-wrapper">
                    <iframe src="/fund_page" title="åŸºé‡‘æŸ¥è¯¢" onload="hideLoading()"></iframe>
                </div>

                <!-- åŸºé‡‘äº¤æ˜“ç®¡ç†é¡µé¢ Iframe -->
                <div id="fund_transWrapper" class="iframe-wrapper">
                    <iframe src="/fund_trans_page" title="åŸºé‡‘äº¤æ˜“ç®¡ç†" onload="hideLoading()"></iframe>
                </div>

                <!-- ä»·æ ¼é€šçŸ¥ç®¡ç†é¡µé¢ Iframe -->
                <div id="notificationWrapper" class="iframe-wrapper">
                    <iframe src="/notification_page" title="ä»·æ ¼é€šçŸ¥ç®¡ç†" onload="hideLoading()"></iframe>
                </div>

                <!-- ç³»ç»Ÿæ›´æ–°é¡µé¢ Iframe -->
                <div id="updateWrapper" class="iframe-wrapper">
                    <iframe src="/update" title="ç³»ç»Ÿæ›´æ–°" onload="hideLoading()"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šæ—¥å¿—æ¨¡æ€æ¡† (æ”¾åœ¨ body æœ€åº•éƒ¨) -->
    <div id="logModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç³»ç»Ÿæ—¥å¿— (è‡ªåŠ¨åˆ·æ–°: 2ç§’)</h3>
                <div>
                    <button class="btn btn-danger btn-sm" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                    <button class="btn btn-secondary btn-sm" onclick="closeLogModal()">å…³é—­</button>
                </div>
            </div>
            <div id="logContent" class="modal-body">
                <!-- æ—¥å¿—å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'stock_monitor_current_view';
        let currentView = 'stock';
        let isGlobalPaused = false;
        let logRefreshInterval = null; // æ–°å¢ï¼šæ—¥å¿—åˆ·æ–°å®šæ—¶å™¨

        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);

            // ä» localStorage æ¢å¤ä¸Šæ¬¡ä¿å­˜çš„é¡µé¢çŠ¶æ€
            const savedView = localStorage.getItem(STORAGE_KEY);
            if (savedView && ['stock', 'fund', 'fund_trans', 'notification', 'update'].includes(savedView)) {
                currentView = savedView;
            }
            switchView(currentView, false); // æ¢å¤è§†å›¾ï¼Œä¸æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        });

        function switchView(view, showLoad = true) {
            if (currentView === view) return;
            if (showLoad) showLoading();

            // ä¿å­˜å½“å‰é¡µé¢çŠ¶æ€åˆ° localStorage
            localStorage.setItem(STORAGE_KEY, view);

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.nav-item[onclick="switchView('${view}')"]`);
            if (activeItem) activeItem.classList.add('active');

            const titleMap = {
                'stock': 'è‚¡ç¥¨ç›‘æ§',
                'fund': 'åŸºé‡‘æŸ¥è¯¢',
                'fund_trans': 'åŸºé‡‘äº¤æ˜“ç®¡ç†',
                'notification': 'ä»·æ ¼é€šçŸ¥ç®¡ç†',
                'update': 'ç³»ç»Ÿæ›´æ–°'
            };
            document.getElementById('viewTitle').textContent = titleMap[view];

            document.querySelectorAll('.iframe-wrapper').forEach(wrapper => wrapper.classList.remove('active'));

            setTimeout(() => {
                const targetWrapper = document.getElementById(view + 'Wrapper');
                if (targetWrapper) {
                    targetWrapper.classList.add('active');
                }
                currentView = view;
                if (showLoad) hideLoading();
            }, 300);
        }

        function globalManualRefresh() {
            showLoading();
            const activeWrapper = document.querySelector('.iframe-wrapper.active iframe');
            if (activeWrapper) {
                activeWrapper.contentWindow.postMessage({ type: 'MANUAL_REFRESH' }, window.location.origin);
            }
            setTimeout(hideLoading, 500);
        }

        // é€šçŸ¥æ‰€æœ‰iframeåˆ·æ–°æ•°æ®
        function notifyAllFrames(message) {
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                try {
                    iframe.contentWindow.postMessage(message, window.location.origin);
                } catch (e) {
                    console.warn('æ— æ³•å‘ iframe å‘é€æ¶ˆæ¯:', e);
                }
            });
        }

        // ç›‘å¬æ¥è‡ªå­é¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) return;

            // å¦‚æœå­é¡µé¢é€šçŸ¥æ•°æ®å·²æ›´æ”¹ï¼Œé€šçŸ¥æ‰€æœ‰é¡µé¢åˆ·æ–°
            if (event.data.type === 'DATA_CHANGED') {
                notifyAllFrames({ type: 'REFRESH_DATA' });
            }
        });

        function toggleGlobalRefresh() {
            isGlobalPaused = !isGlobalPaused;
            const btn = document.getElementById('pauseBtn');
            const statusIndicator = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            
            if (isGlobalPaused) {
                btn.textContent = 'æ¢å¤åˆ·æ–°';
                btn.classList.add('active');
                statusIndicator.className = 'status-indicator paused';
                statusText.textContent = 'å…¨å±€æš‚åœ';
                broadcastToIframes({ type: 'PAUSE_REFRESH' });
            } else {
                btn.textContent = 'æš‚åœåˆ·æ–°';
                btn.classList.remove('active');
                statusIndicator.className = 'status-indicator';
                statusText.textContent = 'ç³»ç»Ÿè¿è¡Œä¸­';
                broadcastToIframes({ type: 'RESUME_REFRESH' });
            }
        }

        function broadcastToIframes(message) {
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                try {
                    iframe.contentWindow.postMessage(message, window.location.origin);
                } catch (e) {
                    console.warn('æ— æ³•å‘ iframe å‘é€æ¶ˆæ¯:', e);
                }
            });
        }

        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('currentTime').textContent = timeStr;
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // --- æ–°å¢ï¼šæ—¥å¿—ç›¸å…³åŠŸèƒ½ ---
        
        function openLogModal() {
            const modal = document.getElementById('logModal');
            modal.style.display = 'flex';
            
            // ç«‹å³è·å–ä¸€æ¬¡æ—¥å¿—
            fetchLogs();
            
            // å¯åŠ¨å®šæ—¶å™¨ï¼Œæ¯2ç§’åˆ·æ–°ä¸€æ¬¡
            logRefreshInterval = setInterval(fetchLogs, 2000);
        }

        function closeLogModal() {
            const modal = document.getElementById('logModal');
            modal.style.display = 'none';
            
            // å…³é—­æ—¶æ¸…é™¤å®šæ—¶å™¨ï¼Œé˜²æ­¢åå°æŒç»­è¯·æ±‚
            if (logRefreshInterval) {
                clearInterval(logRefreshInterval);
                logRefreshInterval = null;
            }
        }

        async function fetchLogs() {
            const logContent = document.getElementById('logContent');
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
            if (!logContent.innerHTML.includes('log-entry')) {
                logContent.innerHTML = '<div style="text-align: center; padding: 20px;">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>';
            }
            
            try {
                const response = await fetch('/api/log/list');
                if (!response.ok) throw new Error('è·å–æ—¥å¿—å¤±è´¥');
                
                const logs = await response.json();
                
                if (logs.length === 0) {
                    logContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— æ—¥å¿—è®°å½•</div>';
                    return;
                }

                // æ ¼å¼åŒ–æ˜¾ç¤ºï¼šæ—¶é—´-é¡µé¢-å‡½æ•°-å†…å®¹
                let html = '';
                // æ­£åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ (logs æ•°ç»„æ˜¯æŒ‰æ—¶é—´é¡ºåºçš„ï¼Œæœ€æ–°çš„åœ¨æœ€å)
                // æ‰€ä»¥æˆ‘ä»¬ä»åå¾€å‰éå†ï¼Œä½†ä¸åè½¬æ•°ç»„ï¼Œè¿™æ ·æœ€æ–°çš„åœ¨é¡¶éƒ¨
                for (let i = logs.length - 1; i >= 0; i--) {
                    const log = logs[i];
                    // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ä»¥é˜²æ­¢XSSå’ŒHTMLç»“æ„ç ´å
                    const escapedMessage = log.message
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#x27;');

                    const escapedPage = log.page
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#x27;');

                    const escapedFunction = log.function
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#x27;');

                    // å°†å®Œæ•´æ—¥å¿—å†…å®¹ä½œä¸º title å±æ€§ï¼Œé¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤º
                    const fullLogText = `[${log.timestamp}] [${escapedPage}] [${escapedFunction}] [${log.level}] ${escapedMessage}`;
                    html += `
                        <div class="log-entry" title="${fullLogText}" onclick="copyLogToClipboard(this, '${fullLogText.replace(/'/g, "\\'")}')">
                            <span class="log-timestamp">[${log.timestamp}]</span>
                            <span class="log-page">[${escapedPage}]</span>
                            <span class="log-function">[${escapedFunction}]</span>
                            <span class="log-level log-level-${log.level}">[${log.level}]</span>
                            <span class="log-message">${escapedMessage}</span>
                        </div>
                    `;
                }
                logContent.innerHTML = html;
                
            } catch (error) {
                logContent.innerHTML = `<div style="color: red;">é”™è¯¯: ${error.message}</div>`;
                // å¦‚æœå‡ºé”™ï¼Œä¹Ÿåœæ­¢åˆ·æ–°ï¼Œé¿å…æ­»å¾ªç¯
                if (logRefreshInterval) {
                    clearInterval(logRefreshInterval);
                    logRefreshInterval = null;
                }
            }
        }

        // --- æ–°å¢ï¼šå¤åˆ¶æ—¥å¿—åˆ°å‰ªè´´æ¿ ---
        function copyLogToClipboard(element, logText) {
            // ä½¿ç”¨ navigator.clipboard API å¤åˆ¶æ–‡æœ¬
            navigator.clipboard.writeText(logText).then(() => {
                // å¤åˆ¶æˆåŠŸï¼Œæ·»åŠ è§†è§‰åé¦ˆ
                element.classList.add('copied');
                
                // æ˜¾ç¤º Toast æç¤º
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                
                // 1.5ç§’åç§»é™¤é«˜äº®æ ·å¼
                setTimeout(() => {
                    element.classList.remove('copied');
                }, 1500);
            }).catch(err => {
                // å¤åˆ¶å¤±è´¥
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            });
        }

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function showCustomConfirm(message, onConfirm, onCancel) {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'confirm-modal';
            overlay.id = 'customConfirmOverlay';

            // åˆ›å»ºå¯¹è¯æ¡†å†…å®¹
            overlay.innerHTML = `
                <div class="confirm-modal-content">
                    <div class="confirm-message">${message}</div>
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm" onclick="handleConfirmAction(true)">ç¡®å®š</button>
                        <button class="confirm-btn cancel" onclick="handleConfirmAction(false)">å–æ¶ˆ</button>
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(overlay);

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            overlay.style.display = 'flex';

            // ä¿å­˜å›è°ƒå‡½æ•°
            window.currentConfirmCallback = {
                onConfirm: onConfirm,
                onCancel: onCancel || (() => {})
            };
        }

        // å¤„ç†ç¡®è®¤æ“ä½œ
        function handleConfirmAction(confirmed) {
            const overlay = document.getElementById('customConfirmOverlay');
            if (overlay) {
                overlay.remove();
            }

            if (window.currentConfirmCallback) {
                if (confirmed && window.currentConfirmCallback.onConfirm) {
                    window.currentConfirmCallback.onConfirm();
                } else if (!confirmed && window.currentConfirmCallback.onCancel) {
                    window.currentConfirmCallback.onCancel();
                }
                // æ¸…é™¤å›è°ƒ
                delete window.currentConfirmCallback;
            }
        }

        async function clearLogs() {
            showCustomConfirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ', async () => {
                try {
                    const response = await fetch('/api/log/clear', { method: 'POST' });
                    if (response.ok) {
                        fetchLogs(); // åˆ·æ–°æ˜¾ç¤º
                        showToast('æ—¥å¿—å·²æ¸…ç©º', 'success');
                    } else {
                        showToast('æ¸…ç©ºæ—¥å¿—å¤±è´¥', 'error');
                    }
                } catch (error) {
                    showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                }
            });
        }
    </script>
    <!-- å…¬å…± JS -->
    <script src="/static/js/common.js"></script>
</body>
</html>
