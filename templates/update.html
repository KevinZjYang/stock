<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统更新 - 股票基金监控系统</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* 更新页面特定样式 */
        body {
            padding: 20px;
            background: #f0f2f5;
        }

        .update-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .update-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .update-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
        }

        .update-header h4 {
            margin: 0;
            font-weight: 600;
        }

        .update-body {
            padding: 20px;
        }

        .status-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-card {
            flex: 1;
            min-width: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .status-card h5 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .status-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .version-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 10px;
            font-size: 13px;
            color: #7f8c8d;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .action-buttons .btn {
            min-width: 120px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            background-color: #95a5a6;
        }

        .status-indicator.active {
            background-color: #27ae60;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        .log-section {
            margin-top: 20px;
        }

        .log-section h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }

        .log-info { color: #3498db; }
        .log-success { color: #27ae60; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success { background: #27ae60; color: white; }
        .badge.warning { background: #f39c12; color: white; }
        .badge.secondary { background: #95a5a6; color: white; }
        .badge.danger { background: #e74c3c; color: white; }

        @media (max-width: 768px) {
            .status-row {
                flex-direction: column;
            }

            .status-card {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="update-container">
        <div class="update-card">
            <div class="update-header">
                <h4>系统更新</h4>
            </div>
            <div class="update-body">
                <div class="status-row">
                    <div class="status-card">
                        <h5>检查更新</h5>
                        <div class="action-buttons">
                            <button id="checkUpdateBtn" class="btn btn-primary">
                                检查更新
                            </button>
                        </div>
                        <div style="margin-top: 15px;">
                            <span class="status-indicator" id="statusIndicator"></span>
                            <span id="statusText">等待检查...</span>
                        </div>
                        <div class="version-info">
                            <span>当前: <strong id="currentVersion">-</strong></span>
                            <span>远程: <strong id="remoteVersion">-</strong></span>
                        </div>
                    </div>
                    <div class="status-card">
                        <h5>执行更新</h5>
                        <div class="action-buttons">
                            <button id="performUpdateBtn" class="btn btn-success" disabled>
                                执行更新
                            </button>
                        </div>
                        <div style="margin-top: 15px;">
                            <span class="badge secondary" id="updateCount">无更新</span>
                        </div>
                    </div>
                    <div class="status-card">
                        <h5>重启应用</h5>
                        <div class="action-buttons">
                            <button id="restartAppBtn" class="btn btn-warning" disabled>
                                重启应用
                            </button>
                        </div>
                        <div style="margin-top: 15px; font-size: 12px; color: #7f8c8d;">
                            重启后页面自动刷新
                        </div>
                    </div>
                </div>

                <div class="log-section">
                    <h5>更新日志</h5>
                    <div class="log-container" id="updateLog">
                        <div style="color: #999; text-align: center; padding: 20px;">暂无更新日志</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        // 更新状态
        let hasUpdate = false;
        let updateCount = 0;

        // DOM 元素
        const checkUpdateBtn = document.getElementById('checkUpdateBtn');
        const performUpdateBtn = document.getElementById('performUpdateBtn');
        const restartAppBtn = document.getElementById('restartAppBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const updateCountEl = document.getElementById('updateCount');
        const updateLog = document.getElementById('updateLog');
        const currentVersionEl = document.getElementById('currentVersion');
        const remoteVersionEl = document.getElementById('remoteVersion');

        // 添加日志条目
        function addLogEntry(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.innerHTML = `<small>[${timestamp}] ${message}</small>`;
            updateLog.appendChild(logEntry);
            updateLog.scrollTop = updateLog.scrollHeight;
        }

        // 检查更新
        async function checkForUpdate() {
            checkUpdateBtn.disabled = true;
            checkUpdateBtn.textContent = '检查中...';

            try {
                addLogEntry('info', '正在检查更新...');
                const response = await fetch('/api/update/check');
                const data = await response.json();

                // 更新版本信息显示
                currentVersionEl.textContent = data.current_version || '未知';
                remoteVersionEl.textContent = data.remote_version || '未知';

                if (data.has_update) {
                    hasUpdate = true;
                    statusIndicator.className = 'status-indicator active';
                    statusText.textContent = data.message || '发现新版本';
                    statusText.style.color = '#27ae60';
                    updateCountEl.className = 'badge success';
                    updateCountEl.textContent = '有更新';
                    performUpdateBtn.disabled = false;
                    addLogEntry('success', data.message || '发现新版本');
                } else {
                    hasUpdate = false;
                    statusIndicator.className = 'status-indicator';
                    statusText.textContent = data.message || '已是最新版本';
                    statusText.style.color = '#7f8c8d';
                    updateCountEl.className = 'badge secondary';
                    updateCountEl.textContent = '无更新';
                    performUpdateBtn.disabled = true;
                    addLogEntry('info', data.message || '当前已是最新版本');
                }
                // 无论是否有更新，都启用重启按钮
                restartAppBtn.disabled = false;

                if (data.error) {
                    addLogEntry('error', `检查更新时出错: ${data.error}`);
                }
            } catch (error) {
                addLogEntry('error', `检查更新时出错: ${error.message}`);
                statusText.textContent = '检查失败';
                statusText.style.color = '#e74c3c';
            } finally {
                checkUpdateBtn.disabled = false;
                checkUpdateBtn.textContent = '检查更新';
            }
        }

        // 执行更新
        async function performUpdate() {
            if (!hasUpdate) {
                showToast('没有可用更新', 'warning');
                return;
            }

            performUpdateBtn.disabled = true;
            performUpdateBtn.textContent = '更新中...';

            try {
                addLogEntry('info', '开始下载更新...');
                const response = await fetch('/api/update/perform', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    updateCount = data.update_count || 0;
                    addLogEntry('success', '更新下载完成');
                    addLogEntry('success', '更新已准备好，重启后生效');
                    showToast('更新成功，请重启应用', 'success');
                } else {
                    addLogEntry('error', `更新失败: ${data.message || data.error}`);
                    showToast('更新失败: ' + (data.message || data.error), 'error');
                }
            } catch (error) {
                addLogEntry('error', `更新失败: ${error.message}`);
                showToast('更新失败: ' + error.message, 'error');
            } finally {
                performUpdateBtn.disabled = false;
                performUpdateBtn.textContent = '执行更新';
            }
        }

        // 重启应用
        async function restartApp() {
            restartAppBtn.disabled = true;
            restartAppBtn.textContent = '重启中...';

            try {
                addLogEntry('info', '正在重启应用...');
                const response = await fetch('/api/update/restart', { method: 'POST' });
                const data = await response.json();

                if (data.success || data.message) {
                    addLogEntry('success', '重启指令已发送');

                    // 显示重启提示
                    showToast('应用正在重启...', 'info');

                    // 等待几秒后刷新页面
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                }
            } catch (error) {
                addLogEntry('error', `重启失败: ${error.message}`);
                showToast('重启失败: ' + error.message, 'error');
                restartAppBtn.disabled = false;
                restartAppBtn.textContent = '重启应用';
            }
        }

        // 绑定事件
        checkUpdateBtn.addEventListener('click', checkForUpdate);
        performUpdateBtn.addEventListener('click', performUpdate);
        restartAppBtn.addEventListener('click', () => {
            showCustomConfirm('确定要重启应用吗？', restartApp, () => {});
        });

        // 页面加载完成后检查更新
        document.addEventListener('DOMContentLoaded', () => {
            checkForUpdate();
        });
    </script>
</body>
</html>
