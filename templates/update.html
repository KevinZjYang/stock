<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统更新 - 股票基金监控系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .update-card {
            max-width: 800px;
            margin: 2rem auto;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active {
            background-color: #28a745;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .log-info { color: #17a2b8; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="update-card card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-arrow-repeat"></i> 系统更新</h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5 class="card-title">检查更新</h5>
                                <p class="card-text">检查是否有可用的更新</p>
                                <button id="checkUpdateBtn" class="btn btn-outline-primary">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" id="checkSpinner"></span>
                                    检查更新
                                </button>
                                <div class="mt-3" id="updateStatus">
                                    <span class="status-indicator" id="statusIndicator"></span>
                                    <span id="statusText">等待检查...</span>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">当前版本: <span id="currentVersion">-</span></small>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">远程版本: <span id="remoteVersion">-</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5 class="card-title">执行更新</h5>
                                <p class="card-text">下载并安装最新版本</p>
                                <button id="performUpdateBtn" class="btn btn-outline-success" disabled>
                                    <span class="spinner-border spinner-border-sm d-none" role="status" id="updateSpinner"></span>
                                    执行更新
                                </button>
                                <div class="mt-3">
                                    <span class="badge bg-secondary" id="updateCount">无更新</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">重启应用</h5>
                                <p class="card-text">重启应用以应用更新</p>
                                <button id="restartAppBtn" class="btn btn-outline-warning" disabled>
                                    <span class="spinner-border spinner-border-sm d-none" role="status" id="restartSpinner"></span>
                                    重启应用
                                </button>
                                <div class="alert alert-info mt-3 d-none" id="restartNotice">
                                    应用重启后，页面将自动刷新
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">更新日志</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="log-container" id="updateLog">
                                    <div class="text-muted text-center py-4">暂无更新日志</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 成功模态框 -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">更新成功</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>更新已成功完成！</p>
                    <p>是否立即重启应用以应用更新？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">稍后重启</button>
                    <button type="button" class="btn btn-success" id="confirmRestartBtn">立即重启</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 更新状态
        let hasUpdate = false;
        let updateCount = 0;

        // DOM 元素
        const checkUpdateBtn = document.getElementById('checkUpdateBtn');
        const performUpdateBtn = document.getElementById('performUpdateBtn');
        const restartAppBtn = document.getElementById('restartAppBtn');
        const checkSpinner = document.getElementById('checkSpinner');
        const updateSpinner = document.getElementById('updateSpinner');
        const restartSpinner = document.getElementById('restartSpinner');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const updateCountEl = document.getElementById('updateCount');
        const updateLog = document.getElementById('updateLog');
        const restartNotice = document.getElementById('restartNotice');
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));

        // 添加日志条目
        function addLogEntry(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.innerHTML = `<small>[${timestamp}] ${message}</small>`;
            updateLog.appendChild(logEntry);
            updateLog.scrollTop = updateLog.scrollHeight;
        }

        // 检查更新
        async function checkForUpdate() {
            checkSpinner.classList.remove('d-none');
            checkUpdateBtn.disabled = true;

            try {
                addLogEntry('info', '正在检查更新...');
                const response = await fetch('/api/update/check');
                const data = await response.json();

                // 更新版本信息显示
                document.getElementById('currentVersion').textContent = data.current_version || '未知';
                document.getElementById('remoteVersion').textContent = data.remote_version || '未知';

                if (data.has_update) {
                    hasUpdate = true;
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = data.message || '发现新版本';
                    statusText.className = 'text-success';
                    updateCountEl.className = 'badge bg-success';
                    updateCountEl.textContent = '有更新';
                    performUpdateBtn.disabled = false;
                    addLogEntry('success', data.message || '发现新版本');
                } else {
                    hasUpdate = false;
                    statusIndicator.className = 'status-indicator';
                    statusText.textContent = data.message || '已是最新版本';
                    statusText.className = 'text-muted';
                    updateCountEl.className = 'badge bg-secondary';
                    updateCountEl.textContent = '无更新';
                    performUpdateBtn.disabled = true;
                    addLogEntry('info', data.message || '当前已是最新版本');
                }

                if (data.error) {
                    addLogEntry('error', `检查更新时出错: ${data.error}`);
                }
            } catch (error) {
                addLogEntry('error', `检查更新时出错: ${error.message}`);
                statusText.textContent = '检查失败';
                statusText.className = 'text-danger';
            } finally {
                checkSpinner.classList.add('d-none');
                checkUpdateBtn.disabled = false;
            }
        }

        // 执行更新
        async function performUpdate() {
            if (!hasUpdate) {
                addLogEntry('warning', '没有可用的更新');
                return;
            }

            if (!confirm('确定要执行更新吗？此操作将下载最新代码并安装依赖。')) {
                return;
            }

            updateSpinner.classList.remove('d-none');
            performUpdateBtn.disabled = true;
            checkUpdateBtn.disabled = true;

            try {
                addLogEntry('info', '开始执行更新...');
                const response = await fetch('/api/update/perform', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (data.success) {
                    addLogEntry('success', data.message || '更新成功');
                    restartAppBtn.disabled = false;

                    // 显示成功模态框
                    successModal.show();
                } else {
                    addLogEntry('error', `更新失败: ${data.error || data.message}`);
                    performUpdateBtn.disabled = false;
                    checkUpdateBtn.disabled = false;
                }
            } catch (error) {
                addLogEntry('error', `执行更新时出错: ${error.message}`);
                performUpdateBtn.disabled = false;
                checkUpdateBtn.disabled = false;
            } finally {
                updateSpinner.classList.add('d-none');
            }
        }

        // 重启应用
        async function restartApp() {
            if (!confirm('确定要重启应用吗？应用将暂时不可用，直到重启完成。')) {
                return;
            }

            restartSpinner.classList.remove('d-none');
            restartAppBtn.disabled = true;
            restartNotice.classList.remove('d-none');

            try {
                addLogEntry('info', '正在重启应用...');
                const response = await fetch('/api/update/restart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                addLogEntry('success', data.message || '重启指令已发送');

                // 显示重启通知并延迟刷新页面
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } catch (error) {
                addLogEntry('error', `重启应用时出错: ${error.message}`);
                restartAppBtn.disabled = false;
            } finally {
                restartSpinner.classList.add('d-none');
            }
        }

        // 事件监听器
        checkUpdateBtn.addEventListener('click', checkForUpdate);
        performUpdateBtn.addEventListener('click', performUpdate);
        restartAppBtn.addEventListener('click', restartApp);
        document.getElementById('confirmRestartBtn').addEventListener('click', () => {
            successModal.hide();
            restartApp();
        });

        // 页面加载时自动检查更新
        window.addEventListener('load', () => {
            addLogEntry('info', '页面已加载，准备检查更新...');
            // 在页面加载时自动检查更新
            checkForUpdate();
        });
    </script>
</body>
</html>