<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金查询</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8f9fa; margin: 0; padding: 0; color: #333; }
        
        /* 输入区域容器 */
        .input-container {
            position: relative; /* 用于定位下拉列表 */
            background: white; 
            padding: 15px 20px; 
            border-bottom: 1px solid #e0e0e0;
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            flex: 1;
            min-width: 300px;
            position: relative; /* 用于定位下拉列表 */
        }

        .input-area input {
            padding: 8px 12px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            flex: 1; 
            min-width: 120px;
            font-size: 14px;
        }
        
        .input-area input:focus {
            border-color: #3498db;
            outline: none;
        }

        /* 统一按钮样式 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            user-select: none;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 16px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-settings {
            background: #95a5a6;
            color: white;
        }

        .btn-settings:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219150;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* 搜索结果下拉列表 */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none; /* 默认隐藏 */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .search-result-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .search-result-item:hover {
            background-color: #f5f5f5;
        }

        .result-code {
            font-weight: bold;
            color: #2c3e50;
            min-width: 60px;
        }

        .result-name {
            color: #555;
            flex: 1;
            text-align: left;
            margin-left: 10px;
        }

        .result-type {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #eee;
            color: #666;
        }

        /* 表格 */
        .table-container { padding: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; white-space: nowrap; }
        th { background: #f8f9fa; font-weight: 600; color: #555; }
        tr:hover { background: #f1f1f1; }
        
        /* 状态颜色 */
        .positive { color: #e74c3c; font-weight: bold; } /* 涨为红 */
        .negative { color: #27ae60; font-weight: bold; } /* 跌为绿 */
        .neutral { color: #7f8c8d; }

        /* 底部状态 */
        .footer-status { padding: 8px 20px; font-size: 12px; color: #666; background: white; border-top: 1px solid #e0e0e0; }
        .footer-status.error { color: #e74c3c; }
        .footer-status.paused { color: #f39c12; }

        /* 模态框 */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
        .modal-content h3 { margin-top: 0; }
        .modal-content input { width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }

        /* Toast */
        #localToastContainer { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }

        /* 自定义确认对话框 */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .confirm-modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .confirm-message {
            margin: 15px 0;
            font-size: 16px;
            color: #333;
        }

        .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s;
        }

        .confirm-btn.confirm {
            background: #e74c3c;
            color: white;
        }

        .confirm-btn.confirm:hover {
            background: #c0392b;
        }

        .confirm-btn.cancel {
            background: #95a5a6;
            color: white;
        }

        .confirm-btn.cancel:hover {
            background: #7f8c8d;
        }

        #fundChartContainer {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .chart-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 16px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- 输入区域容器 -->
    <div class="input-container">
        <div class="input-area">
            <input type="text" id="fundCodeInput" placeholder="输入基金代码或名称 (如 000001 或 华夏成长)" autocomplete="off">
            <button class="btn btn-primary" onclick="addFund()">添加</button>
            <!-- 搜索结果下拉列表 -->
            <div id="searchResults" class="search-results"></div>
        </div>
        <button class="btn btn-settings" onclick="openSettings()">设置</button>
    </div>

    <!-- 表格区域 -->
    <div class="table-container">
        <!-- 进度条容器 -->
        <div id="refreshProgressContainer" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; border: 1px solid #ddd;">
            <div style="display: flex; align-items: center;">
                <div id="progressBar" style="flex: 1; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden;">
                    <div id="progressFill" style="height: 100%; width: 0%; background: #3498db; transition: width 0.3s;"></div>
                </div>
                <span id="progressText" style="margin-left: 15px; font-weight: bold; color: #3498db; min-width: 120px;">准备刷新...</span>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>代码</th>
                    <th>名称</th>
                    <th>类型</th>
                    <th>单位净值</th>
                    <th>估算净值</th>
                    <th>日涨幅</th>
                    <th>周涨幅</th>
                    <th>月涨幅</th>
                    <th>年涨幅</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="fundTableBody">
                <!-- 动态生成行 -->
            </tbody>
        </table>
    </div>

    <!-- 基金详情模态框 -->
    <div id="fundDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="fundDetailTitle">基金详情</h3>
                <button class="btn btn-danger" onclick="closeFundDetailModal()" style="padding: 4px 8px; font-size: 14px;">×</button>
            </div>
            <div id="fundDetailContent">
                <div style="margin-bottom: 15px;">
                    <div style="margin-bottom: 10px;">
                        <strong>时间段选择：</strong>
                        <button class="btn btn-sm" id="period1M" onclick="setPeriod('1M')" style="background: #3498db; color: white;">一个月</button>
                        <button class="btn btn-sm" id="period3M" onclick="setPeriod('3M')">三个月</button>
                        <button class="btn btn-sm" id="period6M" onclick="setPeriod('6M')">半年</button>
                        <button class="btn btn-sm" id="period1Y" onclick="setPeriod('1Y')">一年</button>
                        <button class="btn btn-sm" id="periodALL" onclick="setPeriod('ALL')">成立以来</button>
                    </div>
                    <div id="fundChartContainer" style="height: 400px; margin-bottom: 20px;">
                        <canvas id="fundChart"></canvas>
                    </div>
                </div>
                <div id="fundBasicInfo" style="margin-bottom: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- 底部状态 -->
    <div class="footer-status" id="footerStatus">就绪</div>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>刷新设置</h3>
            <label>基金刷新间隔 (秒):</label>
            <input type="number" id="refreshIntervalInput" min="10" max="3600" placeholder="600">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeSettings()">取消</button>
                <button class="btn btn-primary" onclick="saveSettings()">保存</button>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div id="localToastContainer"></div>

    <script>
        let fundWatchlist = [];
        let isRefreshing = true;
        let refreshInterval = null;
        let refreshTime = 600000; // 默认 10分钟 (600秒 * 1000)
        let lastRefreshTime = null;
        let searchTimeout = null; // 用于防抖

        // 页面初始化
        window.initPage = function() {
            console.log("Fund page initialized");
            
            // 监听父页面消息
            window.addEventListener('message', function(event) {
                if (event.origin !== window.location.origin) return;
                
                if (event.data.type === 'MANUAL_REFRESH') {
                    manualRefresh();
                } else if (event.data.type === 'PAUSE_REFRESH') {
                    if (isRefreshing) toggleRefresh();
                } else if (event.data.type === 'RESUME_REFRESH') {
                    if (!isRefreshing) toggleRefresh();
                }
            });

            // 确保 DOM 加载完成后再执行
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startInit);
            } else {
                startInit();
            }
        };

        function startInit() {
            // 1. 先获取后端设置，再获取关注列表
            fetchSettings().then(() => {
                return fetchFundWatchlist();
            }).then(() => {
                manualRefresh();
                startRefresh();
            }).catch(err => {
                console.error("初始化失败:", err);
                updateFooterStatus("初始化失败，请检查网络或后端服务", "error");
            });
        }

        function isTradingTime() {
            // 基金通常全天都可以查看净值估算，但为了统一逻辑，这里保留交易时间检查
            // 如果基金不需要交易时间检查，可以始终返回 true
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const time = hour * 60 + minute;
            if (day === 0 || day === 6) return false;
            const isAStockTime = (time >= 570 && time <= 690) || (time >= 780 && time <= 900);
            const isHKStockTime = (time >= 570 && time <= 720) || (time >= 780 && time <= 960);
            return isAStockTime || isHKStockTime;
        }

        async function fetchSettings() {
            try {
                const response = await fetch('/api/fund/settings');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const settings = await response.json();
                
                // 优先使用后端返回的基金刷新间隔，如果没有则使用默认值
                if (settings.fund_refresh_interval) {
                    refreshTime = settings.fund_refresh_interval * 1000;
                }
                return true;
            } catch (error) {
                console.error('获取设置失败:', error);
                showToast('获取设置失败，使用默认值', 'warning');
                return true; // 继续执行，使用默认值
            }
        }

        async function fetchFundWatchlist() {
            try {
                const response = await fetch('/api/fund/watchlist');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                fundWatchlist = await response.json();
                updateTable();
                return true;
            } catch (error) {
                console.error('获取基金关注列表失败:', error);
                showToast('获取基金关注列表失败', 'error');
                return false;
            }
        }

        // --- 新增：搜索功能 ---
        const searchInput = document.getElementById('fundCodeInput');
        const searchResults = document.getElementById('searchResults');

        // 监听输入事件
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            // 清除之前的定时器
            if (searchTimeout) clearTimeout(searchTimeout);
            
            // 如果输入为空，隐藏下拉列表
            if (!query) {
                searchResults.style.display = 'none';
                return;
            }

            // 防抖：300ms 后执行搜索
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });

        // 点击外部关闭下拉列表
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        async function performSearch(query) {
            try {
                // 使用专门的基金搜索接口
                const response = await fetch(`/api/fund/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const results = await response.json();

                // 检查是否返回错误
                if (results.error) {
                    throw new Error(results.error);
                }

                displaySearchResults(results);
            } catch (error) {
                console.error('搜索失败:', error);
                searchResults.innerHTML = '<div class="search-result-item" style="color: #e74c3c;">搜索失败: ' + error.message + '</div>';
                searchResults.style.display = 'block';
            }
        }

        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item" style="color: #999;">未找到匹配结果</div>';
            } else {
                searchResults.innerHTML = results.map(item => `
                    <div class="search-result-item" onclick="selectSymbol('${item.code}', '${item.name}')">
                        <span class="result-code">${item.code}</span>
                        <span class="result-name">${item.name}</span>
                        <span class="result-type">${item.type === 'index' ? '指数' : (item.type === 'hk_stock' ? '港股' : (item.type === 'sh_stock' || item.type === 'sz_stock' ? '股票' : '基金'))}</span>
                    </div>
                `).join('');
            }
            searchResults.style.display = 'block';
        }

        function selectSymbol(code, name) {
            searchInput.value = `${code} - ${name}`;
            searchInput.dataset.code = code; // 存储选中的代码
            searchResults.style.display = 'none';
        }

        async function addFund() {
            const input = document.getElementById('fundCodeInput');
            let code = input.dataset.code; // 优先使用选中的代码

            // 如果没有选中代码（用户直接输入），尝试从输入值中提取
            if (!code) {
                const rawValue = input.value.trim();
                // 尝试匹配 "代码 - 名称" 格式
                const match = rawValue.match(/^(\d{5,6})/);
                if (match) {
                    code = match[1];
                } else {
                    // 如果没有匹配到代码，提示错误
                    showToast('请从下拉列表中选择正确的基金', 'warning');
                    return;
                }
            }

            if (!code) {
                showToast('请输入基金代码', 'warning');
                return;
            }

            if (fundWatchlist.includes(code)) {
                showToast(`${code} 已在关注列表中`, 'error');
                return;
            }

            try {
                const response = await fetch('/api/fund/watchlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const result = await response.json();
                if (response.ok) {
                    // 更新前端的基金列表，添加新基金
                    if (!fundWatchlist.includes(code)) {
                        fundWatchlist.push(code);
                    }
                    // 只为新基金创建行，不重新创建所有行
                    if (!document.getElementById(`row-${code}`)) {
                        createRow(code);
                    }
                    input.value = '';
                    input.dataset.code = ''; // 清除选中的代码
                    showToast(`成功添加 ${code}`, 'success');

                    // 添加基金后立即获取该基金的数据，然后更新表格
                    await fetchSingleFundData(code);
                    // 不需要刷新整个列表，因为已经单独更新了新添加的基金
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                console.error('添加基金失败:', error);
                showToast('添加基金失败', 'error');
            }
        }

        // 获取单个基金的数据
        async function fetchSingleFundData(code) {
            try {
                // 首先确保表格中有该基金的行
                if (!document.getElementById(`row-${code}`)) {
                    // 如果没有该基金的行，则创建一行
                    createRow(code);
                }

                // 获取包含走势图的完整基金数据
                const response = await fetch(`/api/fund/detail?code=${code}&period=ALL`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const fundData = await response.json();

                if (fundData.error) {
                    console.log(`基金 ${code} 的数据获取失败: ${fundData.error}`);
                    return null;
                }

                // 更新行数据
                updateRow(fundData);

                // 将数据缓存到基金详情缓存中
                if (!fundDetailsCache[code]) {
                    fundDetailsCache[code] = { ...fundData };
                } else {
                    Object.assign(fundDetailsCache[code], fundData);
                }

                return fundData; // 返回基金数据
            } catch (error) {
                console.error(`获取基金 ${code} 数据失败:`, error);
                return null;
            }
        }

        async function deleteFund(code) {
            showCustomConfirm(`确定要删除 ${code} 吗？`, async () => {
                try {
                    const response = await fetch('/api/fund/watchlist', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        // 从关注列表中移除基金
                        fundWatchlist = result.watchlist;

                        // 从DOM中删除对应的行
                        const row = document.getElementById(`row-${code}`);
                        if (row) {
                            row.remove();
                        }

                        showToast(`成功删除 ${code}`, 'success');
                        // 不需要调用 updateTable() 和 manualRefresh()，因为它们可能会导致不必要的重绘
                        // 删除操作后，页面上不应该再显示该基金
                    } else {
                        // 即使后端返回错误（如基金不在关注列表中），也要从DOM中删除对应的行
                        // 这样可以确保UI与期望的状态一致
                        const row = document.getElementById(`row-${code}`);
                        if (row) {
                            row.remove();
                        }

                        // 显示错误信息，但同时更新UI
                        showToast(result.error || `基金 ${code} 删除失败`, 'error');
                    }
                } catch (error) {
                    console.error('删除基金失败:', error);
                    showToast('删除基金失败', 'error');
                }
            });
        }

        function toggleRefresh() {
            if (isRefreshing) {
                isRefreshing = false;
                clearInterval(refreshInterval);
                updateFooterStatus('刷新已暂停', 'paused');
                showToast('刷新已暂停', 'warning');
            } else {
                isRefreshing = true;
                startRefresh();
                updateFooterStatus('刷新已恢复', 'refreshing');
                showToast('刷新已恢复', 'success');
            }
        }

        function manualRefresh() {
            showToast('正在手动刷新...', 'info');
            fetchPrices(true);
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const input = document.getElementById('refreshIntervalInput');
            input.value = refreshTime / 1000;
            modal.style.display = 'flex';
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'none';
        }

        async function saveSettings() {
            const input = document.getElementById('refreshIntervalInput');
            const newInterval = parseInt(input.value);
            if (newInterval < 10 || newInterval > 3600) {
                showToast('刷新间隔必须在10到3600秒之间', 'error');
                return;
            }
            try {
                const response = await fetch('/api/fund/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fund_refresh_interval: newInterval })
                });
                const result = await response.json();
                if (response.ok) {
                    refreshTime = newInterval * 1000;
                    showToast(`刷新间隔已设置为 ${newInterval} 秒`, 'success');
                    if (isRefreshing) startRefresh();
                    closeSettings();
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                console.error('保存设置失败:', error);
                showToast('保存设置失败', 'error');
            }
        }

        function startRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);

            // 只有在页面可见时才启动定时器
            if (typeof isPageVisible === 'undefined' || isPageVisible) {
                checkAndFetch();
                refreshInterval = setInterval(checkAndFetch, refreshTime);
            }
        }

        function checkAndFetch() {
            // 检查是否应该获取数据：用户未暂停刷新 且 页面可见
            if (!isRefreshing) {
                updateFooterStatus('用户已暂停刷新', 'paused');
                return;
            }
            if (typeof isPageVisible !== 'undefined' && !isPageVisible) {
                // 页面不可见时，不获取数据
                return;
            }
            if (!isTradingTime()) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                updateFooterStatus(`非交易时间 (当前: ${timeStr})`, 'closed');
                return;
            }
            fetchPrices();
        }

        // 用于缓存基金详细数据，包括净值走势图数据
        let fundDetailsCache = {};

        async function fetchPrices(isManual = false) {
            try {
                // 显示进度条
                const progressContainer = document.getElementById('refreshProgressContainer');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');

                progressContainer.style.display = 'block';
                progressFill.style.width = '10%';
                progressText.textContent = '准备刷新...';

                // 获取基金价格
                progressFill.style.width = '30%';
                progressText.textContent = '正在获取数据...';

                const response = await fetch('/api/fund/prices');

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const prices = await response.json();

                progressFill.style.width = '60%';
                progressText.textContent = '更新表格数据...';

                prices.forEach(priceData => {
                    updateRow(priceData);

                    // 将价格数据缓存到基金详情缓存中
                    // 如果缓存中没有该基金的详细数据，至少先缓存基础价格数据
                    if (!fundDetailsCache[priceData.code]) {
                        fundDetailsCache[priceData.code] = { ...priceData };
                    } else {
                        // 如果缓存中已有数据，更新其中的价格相关字段
                        Object.assign(fundDetailsCache[priceData.code], {
                            netWorth: priceData.netWorth,
                            expectWorth: priceData.expectWorth,
                            totalWorth: priceData.totalWorth,
                            expectGrowth: priceData.expectGrowth,
                            dayGrowth: priceData.dayGrowth,
                            lastWeekGrowth: priceData.lastWeekGrowth,
                            lastMonthGrowth: priceData.lastMonthGrowth,
                            lastThreeMonthsGrowth: priceData.lastThreeMonthsGrowth,
                            lastSixMonthsGrowth: priceData.lastSixMonthsGrowth,
                            lastYearGrowth: priceData.lastYearGrowth,
                            buyMin: priceData.buyMin,
                            buySourceRate: priceData.buySourceRate,
                            buyRate: priceData.buyRate,
                            manager: priceData.manager,
                            fundScale: priceData.fundScale,
                            netWorthDate: priceData.netWorthDate,
                            expectWorthDate: priceData.expectWorthDate
                        });
                    }
                });

                progressFill.style.width = '90%';
                progressText.textContent = '完成...';

                lastRefreshTime = new Date();
                const statusText = isManual ? '手动刷新成功' : '刷新成功';
                updateFooterStatus(`${statusText} | 上次刷新: ${lastRefreshTime.toLocaleTimeString()}`, 'refreshing');

                // 完成后隐藏进度条
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                    progressText.textContent = '准备刷新...';
                }, 500);

            } catch (error) {
                console.error('获取基金价格失败:', error);
                updateFooterStatus(`获取基金价格失败: ${error.message}`, 'error');
                showToast('获取基金价格失败', 'error');

                // 出现错误时也要隐藏进度条
                const progressContainer = document.getElementById('refreshProgressContainer');
                progressContainer.style.display = 'none';
            }
        }

        function createRow(code) {
            const tbody = document.getElementById('fundTableBody');
            if (!tbody) return;
            const row = document.createElement('tr');
            row.id = `row-${code}`;
            row.innerHTML = `
                <td>${code}</td>
                <td id="name-${code}" style="cursor: pointer; color: #3498db; text-decoration: underline;">--</td>
                <td id="type-${code}">--</td>
                <td id="netWorth-${code}">--</td>
                <td id="expectWorth-${code}">--</td>
                <td id="dayGrowth-${code}">--</td>
                <td id="lastWeekGrowth-${code}">--</td>
                <td id="lastMonthGrowth-${code}">--</td>
                <td id="lastYearGrowth-${code}">--</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteFund('${code}')">删除</button></td>
            `;
            // 添加点击事件监听器（使用事件委托避免重复绑定）
            // 不在此处添加监听器，而是在表格行创建后统一处理
            tbody.appendChild(row);
        }

        function updateTable() {
            const tbody = document.getElementById('fundTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            fundWatchlist.forEach(code => createRow(code));

            // 为表格主体添加事件监听器（事件委托）
            tbody.removeEventListener('click', handleFundNameClick); // 移除可能已存在的监听器
            tbody.addEventListener('click', handleFundNameClick);
        }

        // 处理基金名称点击事件（使用事件委托）
        function handleFundNameClick(event) {
            // 检查点击的是否是基金名称单元格
            if (event.target && event.target.matches && event.target.matches('[id^="name-"]')) {
                // 从ID中提取基金代码
                const id = event.target.id;
                const code = id.substring('name-'.length);
                if (code) {
                    // 添加视觉反馈，让用户知道点击已生效
                    const originalText = event.target.textContent;
                    const originalColor = event.target.style.color;
                    event.target.textContent = '加载中...';
                    event.target.style.color = '#f39c12'; // 橙色表示加载中

                    // 调用显示基金详情的函数，传入回调函数用于恢复原始文本
                    showFundDetail(code, function() {
                        // 数据加载完成后恢复原始文本和颜色
                        if (document.getElementById(id)) {
                            document.getElementById(id).textContent = originalText;
                            document.getElementById(id).style.color = originalColor;
                        }
                    });
                }
            }
        }

        function updateRow(priceData) {
            const code = priceData.code;
            const row = document.getElementById(`row-${code}`);
            if (!row) {
                // 如果行不存在，先创建它
                createRow(code);
            }

            const nameCell = document.getElementById(`name-${code}`);
            if (nameCell) {
                nameCell.textContent = priceData.name || '--';
                // 设置样式，但不添加事件监听器（使用事件委托）
                nameCell.style.cursor = 'pointer';
                nameCell.style.color = '#3498db';
                nameCell.style.textDecoration = 'underline';
            }

            const typeCell = document.getElementById(`type-${code}`);
            if (typeCell) typeCell.textContent = priceData.type || '--';

            const netWorthCell = document.getElementById(`netWorth-${code}`);
            if (netWorthCell) {
                const netWorth = priceData.netWorth !== null && priceData.netWorth !== undefined ? parseFloat(priceData.netWorth).toFixed(4) : '--';
                const netWorthDate = priceData.netWorthDate || '';
                netWorthCell.innerHTML = `${netWorth}<br><small style="font-size: 10px; color: #666;">${netWorthDate}</small>`;
            }

            const expectWorthCell = document.getElementById(`expectWorth-${code}`);
            if (expectWorthCell) {
                const expectWorth = priceData.expectWorth !== null && priceData.expectWorth !== undefined ? parseFloat(priceData.expectWorth).toFixed(4) : '--';
                const expectWorthDate = priceData.expectWorthDate || '';
                expectWorthCell.innerHTML = `${expectWorth}<br><small style="font-size: 10px; color: #666;">${expectWorthDate}</small>`;
            }

            const dayGrowthCell = document.getElementById(`dayGrowth-${code}`);
            if (dayGrowthCell) {
                if (priceData.dayGrowth !== null && priceData.dayGrowth !== undefined) {
                    const growth = parseFloat(priceData.dayGrowth);
                    dayGrowthCell.textContent = growth.toFixed(2) + '%';
                    dayGrowthCell.className = growth > 0 ? 'positive' : (growth < 0 ? 'negative' : 'neutral');
                } else {
                    dayGrowthCell.textContent = '--';
                    dayGrowthCell.className = '';
                }
            }

            const lastWeekGrowthCell = document.getElementById(`lastWeekGrowth-${code}`);
            if (lastWeekGrowthCell) {
                if (priceData.lastWeekGrowth !== null && priceData.lastWeekGrowth !== undefined) {
                    const growth = parseFloat(priceData.lastWeekGrowth);
                    lastWeekGrowthCell.textContent = growth.toFixed(2) + '%';
                    lastWeekGrowthCell.className = growth > 0 ? 'positive' : (growth < 0 ? 'negative' : 'neutral');
                } else {
                    lastWeekGrowthCell.textContent = '--';
                    lastWeekGrowthCell.className = '';
                }
            }

            const lastMonthGrowthCell = document.getElementById(`lastMonthGrowth-${code}`);
            if (lastMonthGrowthCell) {
                if (priceData.lastMonthGrowth !== null && priceData.lastMonthGrowth !== undefined) {
                    const growth = parseFloat(priceData.lastMonthGrowth);
                    lastMonthGrowthCell.textContent = growth.toFixed(2) + '%';
                    lastMonthGrowthCell.className = growth > 0 ? 'positive' : (growth < 0 ? 'negative' : 'neutral');
                } else {
                    lastMonthGrowthCell.textContent = '--';
                    lastMonthGrowthCell.className = '';
                }
            }

            const lastYearGrowthCell = document.getElementById(`lastYearGrowth-${code}`);
            if (lastYearGrowthCell) {
                if (priceData.lastYearGrowth !== null && priceData.lastYearGrowth !== undefined) {
                    const growth = parseFloat(priceData.lastYearGrowth);
                    lastYearGrowthCell.textContent = growth.toFixed(2) + '%';
                    lastYearGrowthCell.className = growth > 0 ? 'positive' : (growth < 0 ? 'negative' : 'neutral');
                } else {
                    lastYearGrowthCell.textContent = '--';
                    lastYearGrowthCell.className = '';
                }
            }
        }

        function updateFooterStatus(message, type) {
            const footerStatusDiv = document.getElementById('footerStatus');
            if (!footerStatusDiv) return;
            footerStatusDiv.textContent = message;
            footerStatusDiv.className = `footer-status ${type}`;
        }

        function showToast(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            if (window.parent && window.parent.showToast) {
                try {
                    window.parent.showToast(message, type);
                    return;
                } catch (e) {}
            }
            // 本地回退
            const containerId = 'localToastContainer';
            let container = document.getElementById(containerId);
            if (!container) {
                container = document.createElement('div');
                container.id = containerId;
                container.style.cssText = `position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none;`;
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            let bgColor = '#3498db';
            if (type === 'success') bgColor = '#27ae60';
            if (type === 'error') bgColor = '#e74c3c';
            if (type === 'warning') bgColor = '#f39c12';
            toast.style.cssText = `padding: 12px 20px; border-radius: 8px; color: white; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2); text-align: center; background-color: ${bgColor}; pointer-events: auto; box-sizing: border-box; animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 3000);
        }

        // 页面可见性控制变量
        let isPageVisible = true;
        let refreshWasActive = false;

        // 页面可见性变化处理
        function handleVisibilityChange() {
            isPageVisible = !document.hidden;

            if (isPageVisible) {
                // 页面变为可见时，如果之前刷新是激活的，则恢复刷新
                if (refreshWasActive && isRefreshing) {
                    startRefresh();
                }
            } else {
                // 页面变为不可见时，暂停刷新
                if (isRefreshing) {
                    refreshWasActive = true;
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                        updateFooterStatus('页面不可见，数据刷新已暂停', 'paused');
                    }
                } else {
                    refreshWasActive = false;
                }
            }
        }

        // 自定义确认对话框
        function showCustomConfirm(message, onConfirm, onCancel) {
            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.className = 'confirm-modal';
            overlay.id = 'customConfirmOverlay';

            // 创建对话框内容
            overlay.innerHTML = `
                <div class="confirm-modal-content">
                    <div class="confirm-message">${message}</div>
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm" onclick="handleConfirmAction(true)">确定</button>
                        <button class="confirm-btn cancel" onclick="handleConfirmAction(false)">取消</button>
                    </div>
                </div>
            `;

            // 添加到页面
            document.body.appendChild(overlay);

            // 显示对话框
            overlay.style.display = 'flex';

            // 保存回调函数
            window.currentConfirmCallback = {
                onConfirm: onConfirm,
                onCancel: onCancel || (() => {})
            };
        }

        // 处理确认操作
        function handleConfirmAction(confirmed) {
            const overlay = document.getElementById('customConfirmOverlay');
            if (overlay) {
                overlay.remove();
            }

            if (window.currentConfirmCallback) {
                if (confirmed && window.currentConfirmCallback.onConfirm) {
                    window.currentConfirmCallback.onConfirm();
                } else if (!confirmed && window.currentConfirmCallback.onCancel) {
                    window.currentConfirmCallback.onCancel();
                }
                // 清除回调
                delete window.currentConfirmCallback;
            }
        }

        // 页面加载完成后执行初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 添加页面可见性监听器
            document.addEventListener('visibilitychange', handleVisibilityChange);

            window.initPage();

            // 监听来自父页面的消息
            window.addEventListener('message', function(event) {
                if (event.origin !== window.location.origin) return;

                if (event.data.type === 'REFRESH_DATA') {
                    // 在基金页面，我们可能需要刷新基金数据
                    if (typeof fetchPrices === 'function') {
                        fetchPrices();
                    }
                }
            });
        });

        // 如果页面已经加载完成但initPage还没被调用，则手动调用
        if (document.readyState === 'complete') {
            // 页面已经加载完成，但可能initPage还没被调用
            if (typeof window.initPage === 'function') {
                setTimeout(window.initPage, 100); // 延迟一点确保所有资源加载完成
            }
        }

        // 显示基金详情和净值走势图
        async function showFundDetail(code, callback) {
            console.log('开始显示基金详情，基金代码:', code);

            // 首先检查缓存中是否有数据
            if (fundDetailsCache[code]) {
                console.log('缓存中存在基金数据:', fundDetailsCache[code]);

                // 直接使用缓存的数据（现在应该包含净值走势图数据）
                const fundData = fundDetailsCache[code];

                console.log('使用缓存的数据（包含净值走势图数据）');

                // 使用缓存的数据（包含净值走势图数据）
                console.log('使用缓存的基金数据:', fundData);

                // 显示模态框
                document.getElementById('fundDetailModal').style.display = 'flex';

                // 设置标题
                document.getElementById('fundDetailTitle').textContent = `${fundData.name} (${fundData.code})`;

                // 显示基本信息
                const basicInfoHtml = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div><strong>基金类型:</strong> ${fundData.type || '--'}</div>
                        <div><strong>单位净值:</strong> ${fundData.netWorth ? parseFloat(fundData.netWorth).toFixed(4) : '--'}</div>
                        <div><strong>净值日期:</strong> ${fundData.netWorthDate || '--'}</div>
                        <div><strong>估算净值:</strong> ${fundData.expectWorth ? parseFloat(fundData.expectWorth).toFixed(4) : '--'}</div>
                        <div><strong>估算日期:</strong> ${fundData.expectWorthDate || '--'}</div>
                        <div><strong>累计净值:</strong> ${fundData.totalWorth ? parseFloat(fundData.totalWorth).toFixed(4) : '--'}</div>
                        <div><strong>日增长率:</strong> ${fundData.dayGrowth !== null && fundData.dayGrowth !== undefined ? parseFloat(fundData.dayGrowth).toFixed(2) + '%' : '--'}</div>
                        <div><strong>周增长率:</strong> ${fundData.lastWeekGrowth !== null && fundData.lastWeekGrowth !== undefined ? parseFloat(fundData.lastWeekGrowth).toFixed(2) + '%' : '--'}</div>
                        <div><strong>月增长率:</strong> ${fundData.lastMonthGrowth !== null && fundData.lastMonthGrowth !== undefined ? parseFloat(fundData.lastMonthGrowth).toFixed(2) + '%' : '--'}</div>
                        <div><strong>年增长率:</strong> ${fundData.lastYearGrowth !== null && fundData.lastYearGrowth !== undefined ? parseFloat(fundData.lastYearGrowth).toFixed(2) + '%' : '--'}</div>
                        <div><strong>基金经理:</strong> ${fundData.manager || '--'}</div>
                        <div><strong>基金规模:</strong> ${fundData.fundScale || '--'}</div>
                    </div>
                `;
                document.getElementById('fundBasicInfo').innerHTML = basicInfoHtml;

                // 绘制净值走势图
                drawNetWorthChart(fundData, currentPeriod);
            } else {
                console.log('缓存中不存在该基金的数据，需要先获取数据');

                // 如果缓存中没有数据，先尝试从API获取
                try {
                    // 从 /prices 端点获取所有基金数据，然后找到对应基金
                    const response = await fetch('/api/fund/prices');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const allFundsData = await response.json();
                    const fundData = allFundsData.find(fund => fund.code === code);

                    if (fundData) {
                        // 将数据存入缓存
                        fundDetailsCache[code] = fundData;

                        // 显示模态框
                        document.getElementById('fundDetailModal').style.display = 'flex';

                        // 设置标题
                        document.getElementById('fundDetailTitle').textContent = `${fundData.name} (${fundData.code})`;

                        // 显示基本信息
                        const basicInfoHtml = `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div><strong>基金类型:</strong> ${fundData.type || '--'}</div>
                                <div><strong>单位净值:</strong> ${fundData.netWorth ? parseFloat(fundData.netWorth).toFixed(4) : '--'}</div>
                                <div><strong>净值日期:</strong> ${fundData.netWorthDate || '--'}</div>
                                <div><strong>估算净值:</strong> ${fundData.expectWorth ? parseFloat(fundData.expectWorth).toFixed(4) : '--'}</div>
                                <div><strong>估算日期:</strong> ${fundData.expectWorthDate || '--'}</div>
                                <div><strong>累计净值:</strong> ${fundData.totalWorth ? parseFloat(fundData.totalWorth).toFixed(4) : '--'}</div>
                                <div><strong>日增长率:</strong> ${fundData.dayGrowth !== null && fundData.dayGrowth !== undefined ? parseFloat(fundData.dayGrowth).toFixed(2) + '%' : '--'}</div>
                                <div><strong>周增长率:</strong> ${fundData.lastWeekGrowth !== null && fundData.lastWeekGrowth !== undefined ? parseFloat(fundData.lastWeekGrowth).toFixed(2) + '%' : '--'}</div>
                                <div><strong>月增长率:</strong> ${fundData.lastMonthGrowth !== null && fundData.lastMonthGrowth !== undefined ? parseFloat(fundData.lastMonthGrowth).toFixed(2) + '%' : '--'}</div>
                                <div><strong>年增长率:</strong> ${fundData.lastYearGrowth !== null && fundData.lastYearGrowth !== undefined ? parseFloat(fundData.lastYearGrowth).toFixed(2) + '%' : '--'}</div>
                                <div><strong>基金经理:</strong> ${fundData.manager || '--'}</div>
                                <div><strong>基金规模:</strong> ${fundData.fundScale || '--'}</div>
                            </div>
                        `;
                        document.getElementById('fundBasicInfo').innerHTML = basicInfoHtml;

                        // 绘制净值走势图
                        drawNetWorthChart(fundData, currentPeriod);
                    } else {
                        console.error('在基金列表中未找到指定基金:', code);
                        showToast(`未找到基金 ${code} 的数据`, 'error');
                    }
                } catch (error) {
                    console.error('获取基金详情失败:', error);
                    showToast(`获取基金详情失败: ${error.message}`, 'error');
                }
            }

            // 调用回调函数，如果提供了的话
            if (callback && typeof callback === 'function') {
                callback();
            }
        }

        // 绘制净值走势图
        function drawNetWorthChart(fundData) {
            console.log('开始绘制净值走势图，基金数据:', fundData);

            // 净值数据
            const netWorthData = fundData.netWorthData || [];
            const totalNetWorthData = fundData.totalNetWorthData || [];

            console.log('净值数据:', netWorthData);
            console.log('累计净值数据:', totalNetWorthData);
            console.log('netWorthData 类型:', typeof netWorthData);
            console.log('totalNetWorthData 类型:', typeof totalNetWorthData);
            console.log('netWorthData 是否为数组:', Array.isArray(netWorthData));
            console.log('totalNetWorthData 是否为数组:', Array.isArray(totalNetWorthData));

            // 准备图表数据
            const labels = [];
            const netWorthValues = [];
            const totalNetWorthValues = [];

            // 解析净值数据 - 格式可能为 [日期, 单位净值, 净值涨幅, 每份分红] 或其他格式
            if (netWorthData && Array.isArray(netWorthData)) {
                console.log('处理 netWorthData，长度:', netWorthData.length);
                // 只有当数据长度大于0时才处理
                if (netWorthData.length > 0) {
                    netWorthData.forEach((item, index) => {
                        console.log(`netWorthData[${index}]:`, item, '类型:', typeof item);
                        if (Array.isArray(item) && item.length >= 2) {
                            // 格式为 [日期, 单位净值, 净值涨幅, 每份分红]
                            const date = item[0]; // 日期
                            const value = parseFloat(item[1]); // 单位净值
                            console.log(`  - 解析为: 日期=${date}, 净值=${value}, 有效=${!isNaN(value)}`);
                            if (!isNaN(value)) {
                                labels.push(date);
                                netWorthValues.push(value);
                            }
                        } else if (typeof item === 'object' && item !== null) {
                            // 尝试其他可能的格式，如 { date: "...", value: "..." }
                            console.log(`  - 尝试对象格式: x=${item.x}, y=${item.y}, date=${item.date}, value=${item.value}`);
                            if (item.x && item.y) {
                                labels.push(item.x);
                                netWorthValues.push(parseFloat(item.y));
                            } else if (item.date && item.value) {
                                labels.push(item.date);
                                netWorthValues.push(parseFloat(item.value));
                            } else if (item[0] && item[1]) {
                                // 可能是对象形式但可以像数组一样访问
                                labels.push(item[0]);
                                netWorthValues.push(parseFloat(item[1]));
                            }
                        } else {
                            // 如果是简单值，使用索引作为标签
                            const value = parseFloat(item);
                            console.log(`  - 解析为简单值: ${value}, 有效=${!isNaN(value)}`);
                            if (!isNaN(value)) {
                                labels.push(`日期${index+1}`);
                                netWorthValues.push(value);
                            }
                        }
                    });
                } else {
                    console.log('netWorthData 为空数组，跳过处理');
                }
            } else {
                console.log('netWorthData 不是有效的数组格式');
            }

            // 解析累计净值数据 - 格式可能为 [日期, 单位净值, 净值涨幅, 每份分红] 或其他格式
            if (totalNetWorthData && Array.isArray(totalNetWorthData)) {
                console.log('处理 totalNetWorthData，长度:', totalNetWorthData.length);
                // 只有当数据长度大于0时才处理
                if (totalNetWorthData.length > 0) {
                    totalNetWorthData.forEach((item, index) => {
                        console.log(`totalNetWorthData[${index}]:`, item, '类型:', typeof item);
                        if (Array.isArray(item) && item.length >= 2) {
                            // 格式为 [日期, 累计净值, 净值涨幅, 每份分红]
                            const date = item[0]; // 日期
                            const value = parseFloat(item[1]); // 累计净值
                            console.log(`  - 解析为: 日期=${date}, 净值=${value}, 有效=${!isNaN(value)}`);
                            if (!isNaN(value)) {
                                // 如果labels还没有填充，从累计净值数据中获取
                                if (labels.length <= index) {
                                    labels.push(date);
                                }
                                totalNetWorthValues.push(value);
                            }
                        } else if (typeof item === 'object' && item !== null) {
                            // 尝试其他可能的格式
                            console.log(`  - 尝试对象格式: x=${item.x}, y=${item.y}, date=${item.date}, value=${item.value}`);
                            if (item.x && item.y) {
                                if (labels.length <= index) labels.push(item.x);
                                totalNetWorthValues.push(parseFloat(item.y));
                            } else if (item.date && item.value) {
                                if (labels.length <= index) labels.push(item.date);
                                totalNetWorthValues.push(parseFloat(item.value));
                            } else if (item[0] && item[1]) {
                                if (labels.length <= index) labels.push(item[0]);
                                totalNetWorthValues.push(parseFloat(item[1]));
                            }
                        } else {
                            // 如果是简单值，使用索引作为标签
                            const value = parseFloat(item);
                            console.log(`  - 解析为简单值: ${value}, 有效=${!isNaN(value)}`);
                            if (!isNaN(value)) {
                                if (labels.length <= index) labels.push(`日期${index+1}`);
                                totalNetWorthValues.push(value);
                            }
                        }
                    });
                } else {
                    console.log('totalNetWorthData 为空数组，跳过处理');
                }
            } else {
                console.log('totalNetWorthData 不是有效的数组格式');
            }

            console.log('处理后的标签:', labels);
            console.log('处理后的净值值:', netWorthValues);
            console.log('处理后的累计净值值:', totalNetWorthValues);

            // 检查是否有足够的数据来绘制图表
            if (labels.length === 0 || (netWorthValues.length === 0 && totalNetWorthValues.length === 0)) {
                console.log('没有足够的数据来绘制图表');
                // 如果没有数据，显示提示信息
                document.getElementById('fundChartContainer').innerHTML = '<div class="chart-loading">暂无净值走势图数据或数据不足</div>';
                return;
            } else {
                console.log('有足够的数据绘制图表，标签数:', labels.length, '净值点数:', netWorthValues.length, '累计净值点数:', totalNetWorthValues.length);
                // 确保容器中有canvas元素
                if (!document.getElementById('fundChart')) {
                    document.getElementById('fundChartContainer').innerHTML = '<canvas id="fundChart"></canvas>';
                }
            }

            // 销毁之前的图表实例（如果存在）
            if (window.currentChart) {
                try {
                    window.currentChart.destroy();
                } catch (e) {
                    console.warn('销毁���表实��时出错:', e);
                }
            }

            // 确保canvas元素存在
            const canvasElement = document.getElementById('fundChart');
            if (!canvasElement) {
                console.error('找不到canvas元素');
                return;
            }

            // 获取canvas上下文
            const chartCtx = canvasElement.getContext('2d');
            if (!chartCtx) {
                console.error('无法获取canvas上下文');
                return;
            }

            // 创建图表 - 使用更灵活的数据格式
            try {
                // 准备数据点，将标签和值组合成{x,y}格式
                const netWorthDataPoints = labels.map((label, index) => ({
                    x: label,
                    y: netWorthValues[index] !== undefined ? netWorthValues[index] : null
                })).filter(point => point.y !== null);

                const totalNetWorthDataPoints = labels.map((label, index) => ({
                    x: label,
                    y: totalNetWorthValues[index] !== undefined ? totalNetWorthValues[index] : null
                })).filter(point => point.y !== null);

                console.log('准备的单位净值数据点:', netWorthDataPoints);
                console.log('准备的累计净值数据点:', totalNetWorthDataPoints);

                window.currentChart = new Chart(chartCtx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: '单位净值',
                                data: netWorthDataPoints,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1,
                                pointRadius: 2
                            },
                            {
                                label: '累计净值',
                                data: totalNetWorthDataPoints,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1,
                                pointRadius: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'category', // 使用分类轴
                                title: {
                                    display: true,
                                    text: '时间'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '金额'
                                },
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '基金净值走势图'
                            },
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });

                console.log('图表创建成功');
            } catch (e) {
                console.error('创建图表时出错:', e);
                document.getElementById('fundChartContainer').innerHTML = '<div class="chart-loading">图表渲染失���: ' + e.message + '</div>';
            }
        }

        // 当前时间段，默认为一个月（仅用于前端显示，API请求仍使用ALL获取所有数据）
        let currentPeriod = '1M';
        // 请求时间段，始终为ALL以获取所有可用数据
        let requestPeriod = 'ALL';

        // 设置时间段
        function setPeriod(period) {
            currentPeriod = period;

            // 更新按钮样式
            document.querySelectorAll('[id^="period"]').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
            });

            const selectedBtn = document.getElementById(`period${period}`);
            if (selectedBtn) {
                selectedBtn.style.background = '#3498db';
                selectedBtn.style.color = 'white';
            }

            // 重新绘制图表
            if (window.currentFundData) {
                drawNetWorthChart(window.currentFundData, currentPeriod);
            }
        }

        // 过滤数据按时间段
        function parseDate(dateString) {
            // 尝试多种日期格式
            if (!dateString) return null;

            // 如果已经是Date��象，直接返回
            if (dateString instanceof Date) return dateString;

            // 尝试标准格式
            let date = new Date(dateString);

            // 如果标准解析失败，尝试其他格式
            if (isNaN(date.getTime())) {
                // 尝试 "YYYY-MM-DD" 格式
                date = new Date(dateString.replace(/-/g, '/'));
            }

            if (isNaN(date.getTime())) {
                // 尝试 "YYYY/MM/DD" 格式
                date = new Date(dateString);
            }

            // 如果还是失败，返回null
            return isNaN(date.getTime()) ? null : date;
        }

        function filterDataByPeriod(data, period) {
            if (!data || data.length === 0) return [];

            const now = new Date();
            let startDate = new Date(now);

            // 根据时间段设置开始日期
            switch (period) {
                case '1M':
                    startDate.setMonth(startDate.getMonth() - 1);
                    break;
                case '3M':
                    startDate.setMonth(startDate.getMonth() - 3);
                    break;
                case '6M':
                    startDate.setMonth(startDate.getMonth() - 6);
                    break;
                case '1Y':
                    startDate.setFullYear(startDate.getFullYear() - 1);
                    break;
                case 'ALL':
                default:
                    // 不过滤，返回全部数据
                    return data;
            }

            // 将开始日期转换为时间戳便于比较
            const startTime = startDate.getTime();

            // 过滤数据
            return data.filter(item => {
                let itemDate = null;

                // 根据数据格式判断日期字段
                if (Array.isArray(item) && item.length >= 2) {
                    // 格式为 [日期, 单位净值, 净值涨幅, 每份分红]
                    itemDate = parseDate(item[0]);
                } else if (typeof item === 'object' && item !== null) {
                    // 尝试其他可能的格式
                    if (item.x) {
                        itemDate = parseDate(item.x);
                    } else if (item.date) {
                        itemDate = parseDate(item.date);
                    } else if (item[0]) {
                        itemDate = parseDate(item[0]);
                    }
                }

                // 如果无法解析日期，保留该项（避免意外过滤数据）
                if (!itemDate) {
                    console.warn('无法解析日期，保留该项:', item);
                    return true;
                }

                // 检查日期是否在指定范围内
                return itemDate.getTime() >= startTime;
            });
        }

        // 绘制净值走势图
        function drawNetWorthChart(fundData, period = 'ALL') {
            // 保存当前基金数据供后续使用
            window.currentFundData = fundData;
            currentPeriod = period;

            console.log('开始绘制净值走势图，基金数据:', fundData, '时间段:', period);

            // 净值数据
            const netWorthData = fundData.netWorthData || [];
            const totalNetWorthData = fundData.totalNetWorthData || [];

            console.log('净值数据:', netWorthData);
            console.log('累计净值数据:', totalNetWorthData);

            // 根据时间段过滤数据
            const filteredNetWorthData = filterDataByPeriod(netWorthData, period);
            const filteredTotalNetWorthData = filterDataByPeriod(totalNetWorthData, period);

            console.log('过滤后的净值数据:', filteredNetWorthData);
            console.log('过滤后的累计净值数据:', filteredTotalNetWorthData);

            // 准备图表数据
            const labels = [];
            const netWorthValues = [];
            const totalNetWorthValues = [];

            // 解析净值数据 - 格式可能为 [日期, 单位净值, 净值涨幅, 每份分红] 或其他格式
            if (filteredNetWorthData && Array.isArray(filteredNetWorthData)) {
                console.log('处理 netWorthData，长度:', filteredNetWorthData.length);
                // 只有当数据长度大于0时才处理
                if (filteredNetWorthData.length > 0) {
                    filteredNetWorthData.forEach((item, index) => {
                        console.log(`netWorthData[${index}]:`, item, '类型:', typeof item);
                        if (Array.isArray(item) && item.length >= 2) {
                            // 格式为 [日期, 单位净值, 净值涨幅, 每份分红]
                            const date = item[0]; // 日期
                            const value = parseFloat(item[1]); // 单位净值
                            console.log(`  - 解析为: 日期=${date}, 净值=${value}, 有效=${!isNaN(value)}`);
                            if (!isNaN(value)) {
                                labels.push(date);
                                netWorthValues.push(value);
                            }
                        } else if (typeof item === 'object' && item !== null) {
                            // 尝试其他可能的格式，如 { date: "...", value: "..." }
                            console.log(`  - 尝试对象格式: x=${item.x}, y=${item.y}, date=${item.date}, value=${item.value}`);
                            if (item.x && item.y) {
                                labels.push(item.x);
                                netWorthValues.push(parseFloat(item.y));
                            } else if (item.date && item.value) {
                                labels.push(item.date);
                                netWorthValues.push(parseFloat(item.value));
                            } else if (item[0] && item[1]) {
                                // 可能是对象形式但可以像数组一样访问
                                labels.push(item[0]);
                                netWorthValues.push(parseFloat(item[1]));
                            }
                        } else {
                            // 如果是简单值，使用索引作为标签
                            const value = parseFloat(item);
                            console.log(`  - 解析为简单值: ${value}, 有效=${!isNaN(value)}`);
                            if (!isNaN(value)) {
                                labels.push(`日期${index+1}`);
                                netWorthValues.push(value);
                            }
                        }
                    });
                } else {
                    console.log('filteredNetWorthData 为空数组，跳过处理');
                }
            } else {
                console.log('netWorthData 不是有效的数组格式');
            }

            // 解析累计净值数据 - 格式可能为 [日期, 单位净值, 净值涨幅, 每份分红] 或其他格式
            if (filteredTotalNetWorthData && Array.isArray(filteredTotalNetWorthData)) {
                console.log('处理 totalNetWorthData，长度:', filteredTotalNetWorthData.length);
                // 只有当数据长度大于0时才处理
                if (filteredTotalNetWorthData.length > 0) {
                    filteredTotalNetWorthData.forEach((item, index) => {
                        console.log(`totalNetWorthData[${index}]:`, item, '类型:', typeof item);
                        if (Array.isArray(item) && item.length >= 2) {
                            // 格式为 [日期, 累计净值, 净值涨幅, 每份分红]
                            const date = item[0]; // 日期
                            const value = parseFloat(item[1]); // 累计净值
                            console.log(`  - 解析为: 日期=${date}, 净值=${value}, 有效=${!isNaN(value)}`);
                            if (!isNaN(value)) {
                                // 如果labels还没有填充，从累计净值数据中获取
                                if (labels.length <= index) {
                                    labels.push(date);
                                }
                                totalNetWorthValues.push(value);
                            }
                        } else if (typeof item === 'object' && item !== null) {
                            // 尝试其他可能的格式
                            console.log(`  - 尝试对象格式: x=${item.x}, y=${item.y}, date=${item.date}, value=${item.value}`);
                            if (item.x && item.y) {
                                if (labels.length <= index) labels.push(item.x);
                                totalNetWorthValues.push(parseFloat(item.y));
                            } else if (item.date && item.value) {
                                if (labels.length <= index) labels.push(item.date);
                                totalNetWorthValues.push(parseFloat(item.value));
                            } else if (item[0] && item[1]) {
                                if (labels.length <= index) labels.push(item[0]);
                                totalNetWorthValues.push(parseFloat(item[1]));
                            }
                        } else {
                            // 如果是简单值，使用索引作为标签
                            const value = parseFloat(item);
                            console.log(`  - 解析为简单值: ${value}, 有效=${!isNaN(value)}`);
                            if (!isNaN(value)) {
                                if (labels.length <= index) labels.push(`日期${index+1}`);
                                totalNetWorthValues.push(value);
                            }
                        }
                    });
                } else {
                    console.log('filteredTotalNetWorthData 为空数组，跳过处理');
                }
            } else {
                console.log('totalNetWorthData 不是有效的数组格式');
            }

            console.log('处理后的标签:', labels);
            console.log('处理后的净值值:', netWorthValues);
            console.log('处理后的累计净值值:', totalNetWorthValues);

            // 检查是否有足够的数据来绘制图表
            if (labels.length === 0 || (netWorthValues.length === 0 && totalNetWorthValues.length === 0)) {
                console.log('没有足够的数据来绘制图表');
                // 如果没有数据，显示提示信息
                document.getElementById('fundChartContainer').innerHTML = '<div class="chart-loading">暂无净值走势图数据或数据不足</div>';
                return;
            } else {
                console.log('有足够的数据绘制图表，标签数:', labels.length, '净值点数:', netWorthValues.length, '累计净值点数:', totalNetWorthValues.length);
                // 确保容器中有canvas元素
                if (!document.getElementById('fundChart')) {
                    document.getElementById('fundChartContainer').innerHTML = '<canvas id="fundChart"></canvas>';
                }
            }

            // 销毁之前的图表实例（如果存在）
            if (window.currentChart) {
                try {
                    window.currentChart.destroy();
                } catch (e) {
                    console.warn('销毁图表实例时出错:', e);
                }
            }

            // 确保canvas元素存在
            const canvasElement = document.getElementById('fundChart');
            if (!canvasElement) {
                console.error('找不到canvas元素');
                return;
            }

            // 获取canvas上下文
            const chartCtx = canvasElement.getContext('2d');
            if (!chartCtx) {
                console.error('无法获取canvas上下文');
                return;
            }

            // 构建时间段描述
            let periodDescription = '';
            switch (period) {
                case '1M':
                    periodDescription = '一个月';
                    break;
                case '3M':
                    periodDescription = '三个月';
                    break;
                case '6M':
                    periodDescription = '半年';
                    break;
                case '1Y':
                    periodDescription = '一年';
                    break;
                case 'ALL':
                    periodDescription = '成立以来';
                    break;
            }

            // 创建图表 - 使用更灵活的数据格式
            try {
                // 准备数据点，将标签和值组合成{x,y}格式
                const netWorthDataPoints = labels.map((label, index) => ({
                    x: label,
                    y: netWorthValues[index] !== undefined ? netWorthValues[index] : null
                })).filter(point => point.y !== null);

                const totalNetWorthDataPoints = labels.map((label, index) => ({
                    x: label,
                    y: totalNetWorthValues[index] !== undefined ? totalNetWorthValues[index] : null
                })).filter(point => point.y !== null);

                console.log('准备的单位净值数据点:', netWorthDataPoints);
                console.log('准备的累计净值数据点:', totalNetWorthDataPoints);
                console.log('单位净值数据点数量:', netWorthDataPoints.length);
                console.log('累计净值数据点数量:', totalNetWorthDataPoints.length);

                // 根据数据点数量动态调整X轴标签显示
                const dataPointCount = Math.max(netWorthDataPoints.length, totalNetWorthDataPoints.length);
                let maxTicksLimit = 20; // 默认最大标签数

                // 根据数据量调整标签密度
                if (dataPointCount > 100) {
                    maxTicksLimit = 10; // 数据点多时减少标签数量
                } else if (dataPointCount > 50) {
                    maxTicksLimit = 15;
                } else {
                    maxTicksLimit = 20; // 数据点少时可以显示更多标签
                }

                // 创建图表
                window.currentChart = new Chart(chartCtx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: '单位净值',
                                data: netWorthDataPoints,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1,
                                pointRadius: dataPointCount > 100 ? 0 : 2, // 数据点多时隐藏点，减少杂乱
                                pointHoverRadius: 5,
                                spanGaps: true  // 允许跨越缺失数据点
                            },
                            {
                                label: '累计净值',
                                data: totalNetWorthDataPoints,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1,
                                pointRadius: dataPointCount > 100 ? 0 : 2, // 数据点多时隐藏点
                                pointHoverRadius: 5,
                                spanGaps: true  // 允许跨越缺失数据点
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                type: 'category', // 使用分类轴
                                title: {
                                    display: true,
                                    text: '时间'
                                },
                                ticks: {
                                    maxRotation: 60,
                                    minRotation: 45,
                                    maxTicksLimit: maxTicksLimit,
                                    // 对于大量数据，可以使用回调函数来控制标签显示
                                    callback: function(value, index, values) {
                                        // 每隔一定数量的标签显示一个，避免过于密集
                                        if (dataPointCount > 100) {
                                            // 如果数据点多，只显示每5个中的1个
                                            return index % Math.ceil(dataPointCount / maxTicksLimit) === 0 ? this.getLabelForValue(value) : '';
                                        }
                                        return this.getLabelForValue(value);
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '金额'
                                },
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `基金净值走势图 (${periodDescription})`
                            },
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                // 自定义tooltip内容以提高可读性
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('zh-CN', { minimumFractionDigits: 4, maximumFractionDigits: 4 }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                console.log('图表创建成功');
            } catch (e) {
                console.error('创建图表时出错:', e);
                document.getElementById('fundChartContainer').innerHTML = '<div class="chart-loading">图表渲染失败: ' + e.message + '</div>';
            }
        }

        // 关闭基金详情模态框
        function closeFundDetailModal() {
            document.getElementById('fundDetailModal').style.display = 'none';
            // 销毁图表以释放资源
            if (window.currentChart) {
                window.currentChart.destroy();
                window.currentChart = null;
            }
        }

    </script>
</body>
</html>
